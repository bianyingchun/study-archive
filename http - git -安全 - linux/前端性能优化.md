### 前言

什么样的网页对于用户体验是好的？无非是更快速的加载，更高效的运行，本文我将从加载和运行这两个方面来讨论前端优化。

### 加载优化

加载过程是最为耗时的过程，可能会占到总耗时的`80%时间(**优化重点**)

#### dns 预解析

<link rel="dns-prefetch" href="//hm.baidu.com"/>
#### 减少 HTTP 请求

尽量减少页面的请求数，将多个小文件合并为一个大文件

- 合并 CSS 和 JS
- 使用 CSS 精灵图

#### 使用 HTTP2

取消合并资源

在 HTTP/1.1 中要把多个小资源合并成一个大资源，从而减少请求。而在 HTTP/2 就不需要了，因为 HTTP/2 所有的请求都可以在一个 TCP 连接发送。

#### 服务端渲染

客户端渲染: 获取 HTML 文件，根据需要下载 JavaScript 文件，运行文件，生成 DOM，再渲染。

服务端渲染：服务端返回 HTML 文件，客户端只需解析 HTML。

优点：首屏渲染快，SEO 好。
缺点：配置麻烦，增加了服务器的计算压力。

#### 静态资源使用 CDN

内容分发网络（CDN）是一组分布在多个不同地理位置的 Web 服务器。我们都知道，当服务器离用户越远时，延迟越高。CDN 就是为了解决这一问题，在多个位置部署服务器，让用户离服务器更近，从而缩短请求时间

#### 将 CSS 放在文件头部，JavaScript 文件放在底部

JS 文件也不是不可以放在头部，只要给 script 标签加上 defer 属性就可以了，异步下载，延迟执行。

#### 使用字体图标 iconfont 代替图片图标

字体图标就是将图标制作成一个字体，使用时就跟字体一样，可以设置属性，例如 font-size、color 等等，非常方便。并且字体图标是矢量图，不会失真。还有一个优点是生成的文件特别小。

##### 2.缓存资源

使用缓存可减少向服务器的请求数，节省加载时间，所有静态资源都要在服务器端设置缓存，并且尽量使用长缓存(使用时间戳更新缓存)

- 缓存一切可缓存的资源
- 使用长缓存
- 使用外联的样式和脚本

##### 3. 压缩文件

减少资源大小可加快网页显示速度，对代码进行压缩，并在服务器端设置 GZip

- 压缩代码(多余的缩进、空格和换行符)
- 启用 Gzip

在 webpack 可以使用如下插件进行压缩：

JavaScript：UglifyPlugin
CSS ：MiniCssExtractPlugin
HTML：HtmlWebpackPlugin

#### 图片优化

1. 懒加载
   onScroll + getBoudingClientRect
2. 响应式图片
   media query
3. 使用 webp 格式的图片
4. 尽可能利用 CSS3 效果代替图片

### 运行时优化

#### 优化 JavaScript 的执行效率

1. 动画实现，避免使用 setTimeout 或 setInterval，尽量使用 requestAnimationFrame
2. 把耗时长的 JavaScript 代码放到 Web Workers 中去做

#### style 降低样式计算的范围和复杂度

降低 css 样式选择器的复杂度

#### 减少重绘重排

当重新生成渲染树后，就要将渲染树每个节点绘制到屏幕，这个过程叫重绘。不是所有的动作都会导致重排，例如改变字体颜色，只会导致重绘。记住，重排会导致重绘，重绘不会导致重排 。

##### 什么操作会导致重排？

- 添加或删除可见的 DOM 元素
- 元素位置改变
- 元素尺寸改变
- 内容改变
- 浏览器窗口尺寸改变

##### 如何减少重排重绘？

<!-- 减少dom操作、替换高性能api、暂存引用、减少重排、开启硬件加速等
 -->

- 用 JavaScript 修改样式时，最好不要直接写样式，而是替换 class 来改变样式。

- 如果要对 DOM 元素执行一系列操作，可以将 DOM 元素脱离文档流，修改完成后，再将它带回文档。推荐使用隐藏元素（display:none）或文档碎片（DocumentFragement），都能很好的实现这个方案。
- 批量修改 DOM 元素的核心思想是：

让该元素脱离文档流
对其进行多重改变
将元素带回文档中

#### composition 优先使用渲染层合并属性、控制层数量

使用 transform/opacity 实现动画效果
提升动画效果中的元素 will-change

### 使用事件委托

#### 避免高频事件

防抖，节流

### 参考文章

1. [前端性能优化 24 条建议（2020）](https://segmentfault.com/a/1190000022205291)

2. [深度剖析浏览器渲染性能原理，你到底知道多少？](https://www.jianshu.com/p/a32b890c29b1)

<!-- 补充 -->

#### 检查加载性能

一个网站加载性能如何主要看白屏时间和首屏时间。

- 白屏时间：指从输入网址，到页面开始显示内容的时间。
- 首屏时间：指从输入网址，到页面完全渲染的时间。

将以下脚本放在 </head> 前面就能获取白屏时间。

<script>
    new Date() - performance.timing.navigationStart
</script>

在 window.onload 事件里执行 new Date() - performance.timing.navigationStart 即可获取首屏时间。

### 检查运行性能

配合 chrome 的开发者工具，我们可以查看网站在运行时的性能。
