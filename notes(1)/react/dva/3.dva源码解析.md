[Dva 源码解析](https://dvajs.com/guide/source-code-explore.html)

##

在 src/index.js 里，dva 一共做了这么几件事：

1. 从 'dva' 依赖中引入 dva ：import dva from 'dva';

2. 通过函数生成一个 app 对象：const app = dva();

3. 加载插件：app.use({});

4. 注入 model：app.model(require('./models/example'));

5. 添加路由：app.router(require('./routes/indexAnother'));

6. 启动：app.start('#root');

## 入口

https://github.com/dvajs/dva/blob/master/packages/dva/src/index.js

1. 使用 call 给 dva-core 实例化的 app(这个时候还只有数据层) 的 start 方法增加了一些新功能（或者说，通过代理模式给 model 层增加了 view 层）。
2. 使用 react-redux 完成了 react 到 redux 的连接。
3. 添加了 redux 的中间件 react-redux-router，强化了 history 对象的功能。

### 使用 call 方法实现代理模式

dva 中实现代理模式的方式如下：

1. 新建 function ，函数内实例化一个 app 对象。 2. 新建变量指向该对象希望代理的方法， oldStart = app.start。 3. 新建同名方法 start，在其中使用 call，指定 oldStart 的调用者为 app。 4. 令 app.start = start，完成对 app 对象的 start 方法的代理。

```js
export default function (opts = {}) {
  // ...初始化 route ，和添加 route 中间件的方法。

  /**
   * 1. 新建 function ，函数内实例化一个 app 对象。
   *
   */
  const app = core.create(opts, createOpts);
  /**
   * 2. 新建变量指向该对象希望代理的方法
   *
   */
  const oldAppStart = app.start;
  app.router = router;
  /**
   * 4. 令 app.start = start，完成对 app 对象的 start 方法的代理。
   * @type {[type]}
   */
  app.start = start;
  return app;

  // router 赋值

  /**
   * 3.1 新建同名方法 start，
   *
   */
  function start(container) {
    // 合法性检测代码

    /**
     * 3.2 在其中使用 call，指定 oldStart 的调用者为 app。
     */
    oldAppStart.call(app);

    // 因为有 3.2 的执行才有现在的 store
    const store = app._store;

    // 使用高阶组件创建视图
  }
}
```

> 为什么不直接在 start 方式中 oldAppStart ?
> 因为 dva-core 的 start 方法里有用到 this，不用 call 指定调用者为 app 的话，oldAppStart() 会找错对象。

### 使用 react-redux 的高阶组件传递 store

经过 call 代理后的 start 方法的主要作用，便是使用 react-redux 的 provider 组件将数据与视图联系了起来，生成 React 元素呈现给使用者。

```js
// 使用 querySelector 获得 dom
if (isString(container)) {
  container = document.querySelector(container);
  invariant(container, `[app.start] container ${container} not found`);
}

// 其他代码

// 实例化 store
oldAppStart.call(app);
const store = app._store;

// export _getProvider for HMR
// ref: https://github.com/dvajs/dva/issues/469
app._getProvider = getProvider.bind(null, store, app);

// If has container, render; else, return react component
// 如果有真实的 dom 对象就把 react 拍进去
if (container) {
  render(container, store, app, app._router);
  // 热加载在这里
  app._plugin.apply("onHmr")(render.bind(null, container, store, app));
} else {
  // 否则就生成一个 react ，供外界调用
  return getProvider(store, this, this._router);
}

// 使用高阶组件包裹组件
function getProvider(store, app, router) {
  return (extraProps) => (
    <Provider store={store}>
      {router({ app, history: app._history, ...extraProps })}
    </Provider>
  );
}

// 真正的 react 在这里
function render(container, store, app, router) {
  const ReactDOM = require("react-dom"); // eslint-disable-line
  ReactDOM.render(
    React.createElement(getProvider(store, app, router)),
    container
  );
}
```
