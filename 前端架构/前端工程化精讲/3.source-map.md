## 什么是 Source Map

在前端开发过程中，通常我们编写的源代码会经过多重处理（编译、封装、压缩等），最后形成产物代码。于是在浏览器中调试产物代码时，我们往往会发现代码变得面目全非，

因此，我们需要一种在调试时**将产物代码显示回源代码**的功能，source map 就是实现这一目标的工具。

source-map 的基本原理是，**在编译处理的过程中，在生成产物代码的同时生成产物代码中被转换的部分与源代码中相应部分的映射关系表。有了这样一张完整的映射表，我们就可以通过 Chrome 控制台中的"Enable Javascript source map"来实现调试时的显示与定位源代码功能。**

对于同一个源文件，根据不同的目标，可以生成不同效果的 source map。它们在构建速度、质量（反解代码与源代码的接近程度以及调试时行号列号等辅助信息的对应情况）、访问方式（在产物文件中或是单独生成 source map 文件）和文件大小等方面各不相同。在开发环境和生产环境下，我们对于 source map 功能的期望也有所不同：

- 在**开发环境**中，通常我们关注的是**\*构建速度快，质量高，以便于提升开发效率，而不关注生成文件的大小和访问方式。**

- 在**生产环境**中，通常我们更关注**是否需要提供线上 source map , 生成的文件大小和访问方式是否会对页面性能造成影响等，其次才是质量和构建速度**。

### 开发环境下 Source Map 推荐预设

通常来说，开发环境首选哪一种预设取决于 source map 对于我们的帮助程度。

如果对项目代码了如指掌，查看产物代码也可以无障碍地了解对应源代码的部分，那就可以关闭 devtool 或使用 eval 来获得最快构建速度。

反之如果在调试时，需要通过 source map 来快速定位到源代码，则优先考虑使用 eval-cheap-module-source-map，它的质量与初次/再次构建速度都属于次优级，以牺牲定位到列的功能为代价换取更快的构建速度通常也是值得的。

在其他情况下，根据对质量要求更高或是对速度要求更高的不同情况，可以分别考虑使用 eval-source-map 或 eval-cheap-source-map。

了解了开发环境下如何选择 source map 预设后，我们再来补充几种工具和脚手架中的默认预设：

- Webpack 配置中，如果不设定 devtool，则使用默认值 eval，即速度与 devtool:false 几乎相同、但模块代码后多了 sourceURL 以帮助定位模块的文件名称。

- create-react-app 中，在生产环境下，根据 shouldUseSourceMap 参数决定使用‘source-map’或 false；在开发环境下使用‘cheap-module-source-map’（不包含列信息的源代码，但更快）。

- vue-cli-service 中，与 creat-react-app 中相同。

除了上面讨论的这些简单的预设外，Webpack 还允许开发者直接使用对应插件来进行更精细化的 source map 控制，在开发环境下我们首选的还是 EvalSourceMapDevToolPlugin。

https://juejin.cn/post/7023242274876162084#heading-19

### 可选值

#### eval 模式：

- 生成代码通过 eval 执行
- 源代码位置通过 @sourceURL 注明 👇🏻
- **无法定位到错误位置，只能定位到某个文件**
- 不用生成 SourceMap 文件，**打包速度快**

#### source-map 模式：

- 在**源代码**中定位到错误所在**行列信息**
- 生成了对应的 SourceMap 文件，**打包速度慢**

#### eval-source-map 模式：

- 生成代码通过 eval 执行
- 包含 dataUrl 形式的 SourceMap 文件
- 可以在**编译后的代码中定位到错误所在行列信息**
- 生成 dataUrl 形式的 SourceMap，**打包速度慢**

#### eval-cheap-source-map 模式：

- 生成代码通过 eval 执行
- 包含 dataUrl 形式的 SourceMap 文件
- 可以在**编译后的代码中定位到错误所在行信息**
- 不需要定位列信息，打包速度较快
- 在源代码中定位到错误所在行信息

#### eval-cheap-module-source-map 模式：

- 生成代码通过 eval 执行
- 包含 dataUrl 形式的 SourceMap 文件
- 可以在编译后的代码中定位到错误所在行信息
- 不需要定位列信息，打包速度较快
- 在源代码中定位到错误所在行信息

#### inline-source-map 模式：

通过 dataUrl 的形式引入 SourceMap 文件， 余下和 source-map 模式一样

#### hidden-source-map 模式：

- 看不到 SourceMap 效果，但是生成了 SourceMap 文件

#### nosources-source-map 模式：

- 能看到错误出现的位置

- 但是没有办法现实对应的源码

### 关键字

^(inline-|hidden-|eval-)?(nosources-)?(cheap-(module-)?)?source-map$

- hidden
  生成 SourceMap 文件，但不使用
- eval
  使用 eval 包裹模块代码
- inline
  将.map 作为 DataURI 嵌入，不单独生成.map 文件

- nosources
  不生成 SourceMap

- module：
  包含 loader 的 sourcemap（比如 jsx to js ，babel 的 sourcemap）
- cheap
  不包含列信息（关于列信息的解释下面会有详细介绍)也不包含 loader 的 sourcemap

- source-map
  产生.map 文件

### 推荐配置

本地开发：

推荐：eval-cheap-module-source-map
理由：

本地开发首次打包慢点没关系，因为 eval 缓存的原因，rebuild 会很快
开发中，我们每行代码不会写的太长，只需要定位到行就行，所以加上 cheap
我们希望能够找到源代码的错误，而不是打包后的，所以需要加上 module

生产环境：

推荐：(none)
理由：

就是不想别人看到我的源代码
