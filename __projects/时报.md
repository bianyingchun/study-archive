报表模板编辑开发
1、将原来写在 xSpreadSheet 内部的数据模型 fieldList 逻辑抽取出来，作为基础表格编辑组件 XlsxEditor 的拓展功能，通过 props.children 传入。
2、改造 xSpreadSheet 插件，editor.js 和 sheet.js 代码，使得部分私有属性方法可在外部调用
3、构造 context,为表格拓展功能组件提供公共数据

1、实现 react 封装 xSpreadSheet 插件，支持自定义编辑组件
2、提供高阶组件 TextInputCreator,包裹自定义编辑组件，以提供可被 xSpreadSheet 使用的相关属性方法，如 on，offset，css
3、在创建 xSpreadSheet 实例时，利用 reactDom.render()渲染自定义编辑组件

1、实例化 xspreadSheet 时替换掉 editor 实例
2、使用富文本编辑器，以支持变量高亮显示等样式
3、公式校验方案：直接执行，try catch 捕获错误
4、xlsxFieldList 不直接操纵 xSpread 对象，而是传递事件到上层，由父组件控制。

时报模板编辑器开发

1. 创建自定义编辑组件 XEditor，实例化 xSpreadSheet 后，渲染 xEditor 并插入到 xSpreadSheet.sheet.editor.el 下，将 xSpreadSheet.sheet.editor 替换成 XEditor 组件实例
2. 监听 XEditor 组件编辑值变化，更新 xSpreadSheet.sheet.data 并执行 sheet.table.render()重新渲染表格;
3. XEditor 内部使用 BraftEditor 富文本编辑器插件，以支持非文本输入和复杂样式，并通过 cell.html 存储实际编辑 html 内容，cell.text 存储 html 转换后的 text。

自定义编辑组件结合数据模型组件实现点击数据字段填充和插入公式：
1、进入编辑状态时，光标 focus 到富文本编辑器内容末尾
2、自定义 draftJS 实体类型，实现插入字段到光标位置，字段块显示特殊样式且作为整体存在不可编辑。
3、非编辑状态时点击数据字段，进入编辑状态，并将富文本编辑器内容填充为字段名称,目前是直接用 HTML 转换后的 editorState 更新富文本内容，字段可被编辑分割，需修改方案。

时报模板编辑开发：
1、生成数据字段列表，修改样式、布局
2、编辑框大小适应文字内容和表格行高
3、修复工具栏初始化时机不确定导致尺寸计算错误的 bug
4、函数和算数操作符选择面板，点击插入到编辑框内
5、表达式合法性校验

1. 所有的基础字段加上昨日同时段数据， 昨日数据
2. 支持设置单元格可否编辑
3. 支持编辑状态时可修改其他属性
4. 多格式字段选择 日期：年/月/日、年.月.日、X 月 X 日，时间：00:00、XX 点
5. 修复自定义 editor 导致的操作历史 bug
6. 字体支持黑体，宋体，微软雅黑

7. 限定账户 ID 所在行不可删除插入等操作，禁用 contextMenu
8. 限定非合计行不可使用聚合函数，只能是普通文本，数据项，或四则运算
9. 限定合计行只可使用聚合函数或普通文本
10. 转换表格数据成后端可以处理的数据格式，样式，配置，并进行校验

1、更新数据项字段
2、修复在多页面同时进行编辑或创建模板时，由于缓存覆盖导致的提交数据与编辑内容不一致问题:在编辑和创建入口，生成唯一 key,作为本地缓存的 key,并通过路由参数 key 实现页面间通信。
3、解决由于手动在第一页插入一个空白模板，导致的分页不匹配问题
4、兼容不可自定义模板

1、兼容不可编辑模板，保留 customerFields 编辑跳过模板编辑步骤
2、数据迁移，兼容上版编辑的报表，用 customerFields 填充媒体账户名称列
3、进入模板编辑时，模板若含有账户名称栏自动填充账户名，并兼容自定义账户名和 customerFields
4、兼容不包含账户 ID 列的模版

1、限定只在数据行首行编辑时显示合并列选项，修改 suggest 组件，增加 controls 属性，控制显示内容
2、当数据编辑行首行输入为表达式，该列数据行首行以下单元格不可编辑，当输入为普通字符串时，设为可编辑
3、当前选中单元格不可编辑，点击数据项时，不填充数据
5、修改数据分块标识：文案，位置，颜色
6、快手增加数据字段上线

1、分时报表模板编辑器 bug 修复和优化：
1、修复由于 xSpreadSheet 插件计算合并单元格位置有误导致的鼠标 hover 单元格角标不显示标注信息的问题
2、修复插件粘贴和剪切操作未特殊处理不可编辑单元的问题，禁止剪切不可编辑单元格，粘贴到不可编辑单元格

---

### XlsxEditor

1. 自定义组件由 React.createPortal 挂载到指定的 dom 下面
2. componentDidMount
   1. initXs
      1. 创建 spredSheet 实例,挂载到指定 container
      2. 初始化自定义组件替换 spreadSheet 下的 Dom 节点
         1. 初始化 自定义编辑器 container
         2. 初始化 自定义工具项 container
         3. 初始化 批注面板
   2. bindEvent 事件绑定
      1. 订阅对 spreadSheet 内部抛出的事件。（对源码做了一定修改，增加了一些自定义事件）
      2. 为 spreadSheet 实例增加自定义方法，主要对一些操作的拦截校验（onBeforeCOlumnDelete）
3. addFieldItem
4. 替换 xpreadShet.editor 为自定义 Editor，注意要提供 xspeadSheet 用到的属性和方法

### 5. Editor

1.  创建自定义编辑组件 XEditor，实例化 xSpreadSheet 后，渲染 xEditor 并插入到 xSpreadSheet.sheet.editor.el 下，将 xSpreadSheet.sheet.editor 替换成 XEditor 组件实例
2.  监听 XEditor 组件编辑值变化，更新 xSpreadSheet.sheet.data 并执行 sheet.table.render()重新渲染表格;
3.  XEditor 内部使用 BraftEditor 富文本编辑器插件(https://segmentfault.com/a/1190000019833834)，以支持非文本输入和复杂样式，并通过 cell.html 存储实际编辑 html 内容，cell.text 存储 html 转换后的 text。

4.  自定义编辑组件结合数据模型组件实现点击数据字段填充和插入公式：
    1. 进入编辑状态时，光标 focus 到富文本编辑器内容末尾。
    2. 自定义 draftJS 实体类型，实现插入字段到光标位置，字段块显示特殊样式且作为整体存在不可编辑。
    3. 非编辑状态时点击数据字段，进入编辑状态，并将富文本编辑器内容填充为字段名称,目前是直接用 HTML 转换后的 editorState 更新富文本内容，字段可被编辑分割，需修改方案。
5.  表达式合法性校验 new function
6.  cell
    1. text : 显示文本
    2. expression ： 表达式
    3. fields ：表达式中包含的变量
    4. rawContent : Draft.js 提供 convertToRaw 方法，用于把 immutable 的 ContentState 对象转为 plain JavaScript 对象，从而拥有作为 JSON 格式存储的能力，对应地，convertFromRaw 方法能将转化后的对象转回 ContentState 对象。
       1. blocks ： blocks 是一个数组，每一项代表当前内容中的一个块级元素。每一个 block 都是一个 contentBlock 对象。每个 contentBlock 都有如下的几个属性值：
          1. key: 标识出这是哪一个 block
          2. type: 这是何种类型的 block, 这里我们就可以定义一个自己的 MediaComponent 来决定展现方式。因为不管是图片还是视频等其它的媒体类型，它们的 type 都是 atomic。
          3. text: 其中的文字
       2. entityMap : 它是以 entity 的 key 作为键值的对象，里面保存了图片、链接等种类的 entity 信息，从中就可获得 blocks 所需要的 entity。
7.  suggest
    1. 合计行自动填充当前列所对应的表达式。
8.  onEditorStateChange 在富文本编辑器值发生变化时
    1.  state === 'input'
    2.  state === 'finished' 判断当前行的类型（表头行，数据行，合计行）、是否使用通用字段等校验数据合法性。 校验表达式合法性
9.  点击字段，自动填充表达式 1. finished : 拼接 blocks, 上报 props，修改 cell 真实值 2. input : 主动修改 editorState 的值（临时编辑值），

### 5.1 富文本编辑器 draft.js

### 介绍

1. 背景介绍：我们公司为用户提供定时从腾讯、头条、快手这三个广告市场拉取广告投放数据的服务。便于客户对广告投放效果的分析。最早是数据部门与客户对接，确定好需要拉取哪些广告主哪些数据字段，报表样式等。再去从服务商拉取数据生成报表，定时发送数据给客户，沟通成本大，用户自定义程度低。报表模板编辑器这个项目就是为了解决这些问题而开发的，类 excel 的操作方式，大大降低了客户的学习成本。用户可自定义去配置报表模板， 并设置报表发送时间。我们也提供了十几种报表模板，用户可直接使用，或在其基础上进行修改。这些在线模板也是我们数据部门通过这个报表编辑器编辑生成录入的。
2. 功能介绍：报表模板主要分为表头，数据行，合计行。
   1. 表头一般是纯文本。
   2. 数据行的行数是和用户选择的广告主账户个数一致的，可以在数据行的首行单元格内录入数据项，数据项可以看成是一个表达式，可以是单个数据字段也可以是多个数据字段的算数运算。编辑器提供了各个广告商的数据字段，同时也提供了一些计算字段，点击后自动填充为多个字段的算数表达式，用户可编辑修改，并实时检测表达式的合法性。除了动态数据，编辑器也支持对每个账户配置自定义常量文本，比如用户别名。
   3. 合计行，通常是对列数据的汇总计算，比如求和，最大值，平均值。我们提供了这些常用聚合函数。当用户点击汇总行单元格时聚合函数时，编辑器会自动将当前列的数据项值与聚合函数合并成新的表达式。用户可以在其基础上更改。
3. 开发工作：
   1. 主要使用了表格插件 xSpread.js，这是一个原生的 js 插件。我需要封装成 react 可用的表格组件。
   2. xSpread.js 是一个轻量的表格插件，仅仅提供最基础的表格编辑功能。为了适配我们的业务，我对源码进行了一定修改，增加了一些自定义事件和方法(比如拦截删除，对特定单元格禁用编辑等)，修改了绘图层，比如特殊单元格的角标，各单元行的类型标识。
   3. 利用 ReactDOM.createPortal 创建了自定义编辑器，自定义工具栏，批注面板，替换或添加到 xSpreadSheet 下。
   4. xSpread.js 中的输入框是最基础的文本输入，我用 react 结合富文本编辑器 DraftJs，自定义了 draftJS 实体类型，编写了一个更强大的输入框，可高亮显示数据字段，自动校验表达式合法性，可自动填充数据，输入时显示 suggest 提示面板，用户点击选择聚合函数和运算符来组合数据项。

## 混剪视频

技术架构：前端(Vue3+TS), 后端（Golang）,视频生成引擎（NodeJs+AE Script+Ffmpeg）
项目介绍：该项目旨在提供高效的在线智能批量广告视频生成和编辑服务，实现了批量模板视频替换、分镜视频生成、在线视频剪辑这三种主要服务。我主要负责视频生成引擎的调研及开发工作，以及部分前端页面的编写。

1. 引入库 after-effects,实现在 NodeJS 中编写 AE 脚本，调用 AE.exe 生成 aep 项目，根据不同的配置，替换或生成视频。除了提供基础的文案、图片、音视频图层的组合生成，还实现了花字、转场动画、文字动效等复杂效果。
2. 根据模板文件，替换文案、图片、视频等元素，并自动根据替换后的资源时长，调节动画时长、处理图片视频缩放，动态调整图层位置，从而批量生成符合原模板效果的视频。
3. 解决了 ae 中文本层不支持内联样式、不能根据文本内容自适应高度、ae 程序执行异常导致后续任务无法执行等问题。
4. 调用 aerender.exe，添加合成到渲染队列生成 avi，通过转码工具 ffmepg 转为最终生成的 mp4 文件。
5. 使用 websocket 与任务调度中心通信，作为消费端处理推送来的任务，完成并上报任务，为保障长连接通信，增加了心跳包机制，连接失败和断开时自动重连。
6. 通过进程守护框架 pm2 启动项目，在抛出错误时自动重启服务。

1. 难点 api 文档表述不清， 部分属性和方法需要自己调试才能获知
2. 内联文本样式
3. 文本动画